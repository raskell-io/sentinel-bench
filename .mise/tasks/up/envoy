#!/usr/bin/env bash
#MISE description="Start Envoy proxy"

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../../.." && pwd)"

echo "Starting Envoy..."
docker-compose -f "$ROOT_DIR/docker/docker-compose.yaml" --profile envoy up -d --force-recreate --pull never

echo "Waiting for Envoy to be ready..."
for i in {1..30}; do
    if curl -sf http://localhost:8080/ >/dev/null 2>&1; then
        echo "Envoy is ready!"
        exit 0
    fi
    sleep 1
done

echo "Warning: Envoy may not be fully ready"
