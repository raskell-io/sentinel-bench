# Sentinel Benchmarking Framework
# mise configuration for task running and dependency management

[env]
# Sentinel image (override with local builds)
# SENTINEL_IMAGE = "sentinel:25.12_17"  # Uncomment to use local build
SENTINEL_IMAGE = "ghcr.io/raskell-io/sentinel:latest"

# Default benchmark settings (can be overridden)
BENCH_DURATION = "60"
BENCH_CONNECTIONS = "100"
BENCH_RATE = "10000"
BENCH_WARMUP = "10"
BENCH_RUNS = "3"
BENCH_TARGET = "http://localhost:8080"

# =============================================================================
# Tool Dependencies
# =============================================================================

[tools]
# Load generators
k6 = "latest"           # Grafana k6 - scriptable load testing
hey = "latest"          # Simple HTTP load generator
wrk = "latest"          # HTTP benchmarking tool

# Note: oha and wrk2 are installed via cargo (see tasks below)
# We use cargo:oha for the Rust-based load generator with HdrHistogram

# =============================================================================
# Short Tasks (inline)
# =============================================================================

[tasks.install-oha]
description = "Install oha load generator via cargo"
run = "cargo install oha --locked"

[tasks.install-wrk2]
description = "Install wrk2 (requires manual build)"
run = """
#!/usr/bin/env bash
set -euo pipefail
if command -v wrk2 &>/dev/null; then
    echo "wrk2 already installed"
    exit 0
fi
echo "wrk2 requires manual installation:"
echo "  git clone https://github.com/giltene/wrk2.git"
echo "  cd wrk2 && make"
echo "  sudo cp wrk /usr/local/bin/wrk2"
"""

[tasks.check-tools]
description = "Check which load generators are available"
run = """
#!/usr/bin/env bash
echo "Load Generator Status:"
echo "======================"
for tool in oha wrk2 wrk hey k6 ab; do
    if command -v "$tool" &>/dev/null; then
        echo "  ✓ $tool: $(command -v $tool)"
    else
        echo "  ✗ $tool: not found"
    fi
done
"""

[tasks.down]
description = "Stop all containers"
run = "docker-compose -f docker/docker-compose.yaml down"

[tasks.logs]
description = "Show proxy logs"
run = "docker-compose -f docker/docker-compose.yaml logs -f"

[tasks.ps]
description = "Show running containers"
run = "docker-compose -f docker/docker-compose.yaml ps"

[tasks.clean]
description = "Clean up results and temporary files"
run = """
#!/usr/bin/env bash
set -euo pipefail
echo "Cleaning results directory..."
rm -rf results/*
echo "Done."
"""

[tasks.results]
description = "List benchmark results"
run = """
#!/usr/bin/env bash
if [[ -d results ]] && [[ -n "$(ls -A results 2>/dev/null)" ]]; then
    find results -maxdepth 1 -type d -name "2*" | sort -r | head -10
else
    echo "No results yet."
    echo ""
    echo "Run a benchmark:"
    echo "  mise run quick:envoy        # Quick 30s test"
    echo "  mise run bench:envoy        # Full benchmark"
    echo "  mise run bench:all          # All proxies"
fi
"""

[tasks.compare]
description = "Compare results across proxies"
run = """
#!/usr/bin/env bash
echo "Comparison report generation coming soon..."
echo ""
echo "Recent results:"
find results -maxdepth 1 -type d -name "2*" | sort -r | head -10
"""
